// ==UserScript==
// @name         è¶…æ˜Ÿå­¦ä¹ é€šå…¨èƒ½ç­”é¢˜åŠ©æ‰‹
// @supportURL   https://github.com/NaiZi899/CEX_AI
// @namespace    http://tampermonkey.net/
// @version      2.7
// @description  v2.7: ç§»é™¤ç»“æŸå¼¹çª—ï¼Œä¿æŒé™é»˜è¿è¡Œï¼›æ”¯æŒä½œä¸š/è€ƒè¯•/é¢„ä¹ å…¨åœºæ™¯ï¼›å¢å¼ºå¡«ç©ºé¢˜å†™å…¥èƒ½åŠ›
// @author       YourName
// @match        *://mooc1.chaoxing.com/mooc-ans/work/*
// @match        *://mooc1-api.chaoxing.com/mooc-ans/work/*
// @match        *://mooc1.chaoxing.com/mooc-ans/mooc2/work/*
// @match        *://mooc1-api.chaoxing.com/mooc-ans/mooc2/work/*
// @match        *://mooc1.chaoxing.com/exam-ans/*
// @match        *://mooc1-api.chaoxing.com/exam-ans/*
// @connect      *
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        unsafeWindow
// ==/UserScript==

(function() {
    'use strict';

    let isRunning = false;
    let stopSignal = false;

    // é»˜è®¤é…ç½®
    const DEFAULT_CONFIG = {
        baseUrl: "https://api.deepseek.com/chat/completions",
        apiKey: "",
        model: "deepseek-chat"
    };

    // --- æ ¸å¿ƒå†™å…¥é€»è¾‘ ---
    function fillAnswer(id, type, ans) {
        const container = document.querySelector(`.questionLi[data="${id}"]`);
        if (!container) {
            log(`âŒ å¤±è´¥: æœªæ‰¾åˆ°é¢˜ç›®å®¹å™¨`, "log-err");
            return;
        }

        // 1. é€‰æ‹©é¢˜/åˆ¤æ–­é¢˜
        if (type.includes("é€‰") || type.includes("åˆ¤æ–­")) {
            try {
                const clean = ans.replace(/[^A-Za-z]/g, '').toUpperCase();
                if (!clean) throw new Error("AIæœªè¿”å›æœ‰æ•ˆé€‰é¡¹");

                let clickCount = 0;
                clean.split('').forEach(char => {
                    const span = container.querySelector(`span[data="${char}"]`);
                    if(span) {
                        const btn = span.closest('.answerBg');
                        const checked = span.classList.contains('check_answer') || span.classList.contains('check_answer_dx');
                        if(btn && !checked) {
                            btn.click();
                            clickCount++;
                        }
                    }
                });

                if (clickCount > 0 || clean.length > 0) {
                    log(`âœ… å·²é€‰: ${clean}`, "log-ok");
                } else {
                    throw new Error("æ‰¾ä¸åˆ°é€‰é¡¹");
                }
            } catch (e) {
                log(`âŒ å¤±è´¥: ${e.message}`, "log-err");
            }
        }
        // 2. å¡«ç©ºé¢˜/ç®€ç­”é¢˜ (UEditor)
        else {
            const ueId = `answerEditor${id}1`;
            let success = false;

            // æ–¹æ¡ˆA: åŸç”ŸAPI
            try {
                const pageUE = unsafeWindow.UE;
                if (pageUE && pageUE.getEditor) {
                    const editor = pageUE.getEditor(ueId);
                    if (editor) {
                        editor.ready(function() {
                            editor.setContent(`<p>${ans}</p>`);
                            if(editor.fireEvent) {
                                editor.fireEvent('blur');
                                editor.fireEvent('contentchange');
                            }
                        });
                        success = true;
                        log(`âœ… å†™å…¥æˆåŠŸ (API)`, "log-ok");
                    }
                }
            } catch (e) {}

            // æ–¹æ¡ˆB: Iframeæ³¨å…¥
            if (!success) {
                try {
                    const textarea = document.getElementById(ueId);
                    const iframe = textarea ? textarea.parentNode.querySelector('iframe') : null;
                    if (iframe && iframe.contentWindow) {
                        const doc = iframe.contentWindow.document;
                        doc.body.innerHTML = `<p>${ans}</p>`;
                        doc.body.dispatchEvent(new Event('input', {bubbles: true}));
                        doc.body.dispatchEvent(new Event('blur', {bubbles: true}));
                        success = true;
                        log(`âœ… å†™å…¥æˆåŠŸ (Iframe)`, "log-ok");
                    }
                } catch (e) {}
            }

            // æ–¹æ¡ˆC: Textarea
            if (!success) {
                try {
                    const textarea = document.getElementById(ueId);
                    if (textarea) {
                        textarea.value = ans;
                        textarea.dispatchEvent(new Event('input', { bubbles: true }));
                        success = true;
                        log(`âœ… å†™å…¥æˆåŠŸ (éšè—åŸŸ)`, "log-ok");
                    }
                } catch(e) {}
            }

            if (success) {
                triggerSave(id);
            } else {
                log(`âŒ å†™å…¥å¤±è´¥: æ— æ³•å®šä½ç¼–è¾‘å™¨`, "log-err");
            }
        }
    }

    function triggerSave(id) {
        setTimeout(() => {
            const saveBtn = document.querySelector(`[onclick*="saveQuestion('${id}"]`);
            if(saveBtn && saveBtn.offsetParent !== null) saveBtn.click();
        }, 500);
    }

    // --- UI ---
    function createGUI() {
        if (document.getElementById('cx-ai-gui')) return;
        const div = document.createElement('div');
        div.id = 'cx-ai-gui';
        div.style.cssText = "position:fixed; top:20px; right:20px; width:280px; background:#fff; border-radius:6px; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:999999; font-size:13px; font-family: sans-serif; border: 1px solid #e0e0e0;";
        div.innerHTML = `
            <div style="background:#333; color:#fff; padding:8px 12px; border-radius:6px 6px 0 0; display:flex; justify-content:space-between; align-items:center; cursor:move;">
                <span>ğŸ¤– ç­”é¢˜åŠ©æ‰‹ v2.7</span>
                <span onclick="this.parentNode.parentNode.style.display='none'" style="cursor:pointer; font-size:14px;">âœ•</span>
            </div>
            <div style="padding:12px; display:flex; flex-direction:column; gap:8px;">
                <input type="text" id="cx-url" value="${localStorage.getItem('cx_url') || DEFAULT_CONFIG.baseUrl}" style="padding:5px; border:1px solid #ddd; border-radius:3px;" placeholder="API URL">
                <input type="password" id="cx-key" value="${localStorage.getItem('cx_key') || DEFAULT_CONFIG.apiKey}" style="padding:5px; border:1px solid #ddd; border-radius:3px;" placeholder="API Key">
                <input type="text" id="cx-model" value="${localStorage.getItem('cx_model') || DEFAULT_CONFIG.model}" style="padding:5px; border:1px solid #ddd; border-radius:3px;" placeholder="Model">
                <div style="display:flex; gap:8px;">
                    <button id="cx-start" style="flex:1; padding:6px; background:#28a745; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">å¼€å§‹è¿è¡Œ</button>
                    <button id="cx-stop" style="flex:1; padding:6px; background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;" disabled>åœæ­¢</button>
                </div>
                <div id="cx-log" style="height:120px; background:#f9f9f9; border:1px solid #eee; overflow-y:auto; padding:6px; font-family:monospace; font-size:12px; line-height:1.4;"></div>
            </div>
        `;
        document.body.appendChild(div);

        const head = div.firstElementChild;
        let isDown = false, offX, offY;
        head.onmousedown = e => { isDown = true; offX = e.clientX - div.offsetLeft; offY = e.clientY - div.offsetTop; };
        document.onmousemove = e => { if(isDown) { div.style.left = (e.clientX - offX) + 'px'; div.style.top = (e.clientY - offY) + 'px'; div.style.right='auto'; }};
        document.onmouseup = () => isDown = false;

        ['cx-url','cx-key','cx-model'].forEach(k=>document.getElementById(k).onchange=e=>localStorage.setItem(k.replace('-','_'),e.target.value));
        document.getElementById('cx-start').onclick = startWork;
        document.getElementById('cx-stop').onclick = stopWork;
    }

    function log(msg, cls) {
        const box = document.getElementById('cx-log');
        const color = cls === 'log-ok' ? '#28a745' : (cls === 'log-err' ? '#dc3545' : '#007bff');
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        box.innerHTML += `<div style="color:${color}; margin-bottom:3px;">[${time}] ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    // --- ä¸šåŠ¡æµç¨‹ ---
    function stopWork() {
        stopSignal = true;
        document.getElementById('cx-start').disabled = false;
        document.getElementById('cx-stop').disabled = true;
        isRunning = false;
        log("â¹ å·²æ‰‹åŠ¨åœæ­¢", "log-err");
    }

    async function startWork() {
        if(isRunning) return;
        isRunning = true;
        stopSignal = false;
        document.getElementById('cx-start').disabled = true;
        document.getElementById('cx-stop').disabled = false;
        document.getElementById('cx-log').innerHTML = "";

        const questions = extractQuestions();
        log(`ğŸš€ è¯†åˆ«åˆ° ${questions.length} é¢˜ï¼Œå¼€å§‹å·¥ä½œ...`, "log-info");

        for(let i=0; i<questions.length; i++) {
            if(stopSignal) break;
            const q = questions[i];

            const el = document.querySelector(`.questionLi[data="${q.id}"]`);
            if(el) el.scrollIntoView({behavior:"smooth", block:"center"});

            try {
                const ans = await askAI(q);
                fillAnswer(q.id, q.type, ans);

                // éšæœºå»¶è¿Ÿ
                await new Promise(r => setTimeout(r, 1000 + Math.random() * 1000));
            } catch(e) {
                log(`âŒ é¢˜${i+1}å¼‚å¸¸: ${e}`, "log-err");
            }
        }
        if (!stopSignal) {
            log("ğŸ‰ å…¨éƒ¨ä»»åŠ¡å·²å®Œæˆ", "log-ok"); // ä»…æ—¥å¿—æç¤ºï¼Œä¸å¼¹çª—
            isRunning = false;
            document.getElementById('cx-start').disabled = false;
            document.getElementById('cx-stop').disabled = true;
        }
    }

    function extractQuestions() {
        const arr = [];
        document.querySelectorAll('.questionLi').forEach(el => {
            const id = el.getAttribute('data');
            if(!id) return;
            let type = el.getAttribute('typename');
            const titleEl = el.querySelector('h3.mark_name');
            let title = titleEl ? titleEl.innerText.replace(/[\r\n\t]/g,'').trim() : "";

            if(!type) {
                if(title.includes("å•é€‰")) type="å•é€‰é¢˜";
                else if(title.includes("å¤šé€‰")) type="å¤šé€‰é¢˜";
                else if(title.includes("å¡«ç©º")) type="å¡«ç©ºé¢˜";
                else if(title.includes("åˆ¤æ–­")) type="åˆ¤æ–­é¢˜";
                else if(title.includes("ç®€ç­”")) type="ç®€ç­”é¢˜";
                else type="æœªçŸ¥";
            }
            title = title.replace(/^(\d+[\.\ã€])?\s*(\([^\)]+\))?\s*/g, '');

            const options = [];
            el.querySelectorAll('.answerBg').forEach(opt => {
                const char = opt.querySelector('.num_option, .num_option_dx')?.getAttribute('data');
                const text = opt.querySelector('.answer_p')?.innerText.trim();
                if(char && text) options.push(`${char}. ${text}`);
            });

            arr.push({ id, type, question: title, options });
        });
        return arr;
    }

    function askAI(q) {
        return new Promise((resolve, reject) => {
            const isText = q.type.includes("å¡«ç©º") || q.type.includes("ç®€ç­”");
            const prompt = `é¢˜ç›®ï¼š${q.question}\n${q.options.length?'é€‰é¡¹ï¼š\n'+q.options.join('\n'):''}\n\nè¦æ±‚ï¼š\n1.é€‰æ‹©é¢˜/åˆ¤æ–­é¢˜åªå›å­—æ¯ã€‚\n2.å¡«ç©º/ç®€ç­”é¢˜ç›´æ¥å›ç­”æ¡ˆå†…å®¹ï¼Œä¸è¦ä»»ä½•è§£é‡Šæˆ–å‰ç¼€ã€‚`;

            GM_xmlhttpRequest({
                method: "POST",
                url: document.getElementById('cx-url').value,
                headers: {"Content-Type":"application/json", "Authorization":`Bearer ${document.getElementById('cx-key').value}`},
                data: JSON.stringify({
                    model: document.getElementById('cx-model').value,
                    messages: [{role:"user", content:prompt}],
                    temperature: 0.1
                }),
                onload: res => {
                    if(res.status===200) {
                        try {
                            const json = JSON.parse(res.responseText);
                            let text = json.choices[0].message.content.trim();
                            if(!isText) text = text.replace(/[^A-Z]/gi, '');
                            text = text.replace(/(^ç­”æ¡ˆ[:ï¼š]\s*)|(ã€‚$)/g, '');
                            resolve(text);
                        } catch(e) { reject("JSON Error"); }
                    } else reject(`HTTP ${res.status}`);
                },
                onerror: e => reject("Net Error")
            });
        });
    }

    window.addEventListener('load', createGUI);
    setTimeout(createGUI, 1500);
})();
